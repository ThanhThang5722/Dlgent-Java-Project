
-- Tao Bang
CREATE TABLE FUNCTION(
  FUNCTION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  FUNCTION_NAME VARCHAR2(100) UNIQUE NOT NULL
);
CREATE TABLE ROLE_GROUP (
  GROUP_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  GROUP_NAME VARCHAR2(100) UNIQUE NOT NULL,
  DESCRIPTION VARCHAR2(255),
  CREATED_AT DATE DEFAULT SYSDATE,
  IS_DELETED  NUMBER(1) DEFAULT 0 CHECK (IS_DELETED IN (0,1))
);

CREATE TABLE ROLE (
  ROLE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  FUNCTION_ID NUMBER(10) REFERENCES FUNCTION(FUNCTION_ID),
  ADD_PERM NUMBER(1) NOT NULL,
  EDIT_PERM NUMBER(1) NOT NULL,
  DELETE_PERM NUMBER(1) NOT NULL,
  DOWNLOAD_PERM NUMBER(1) NOT NULL,
  VIEW_PERM NUMBER(1) NOT NULL,
  CREATED_AT DATE DEFAULT SYSDATE,
  IS_DELETED   NUMBER(1) DEFAULT 0 CHECK (IS_DELETED IN (0,1))
);

CREATE TABLE NGUOI_DUNG (
  USER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  HO_TEN VARCHAR2(100) NOT NULL,
  EMAIL VARCHAR2(150) NOT NULL,
  SDT NVARCHAR2(10) NOT NULL, 
  CCCD NVARCHAR2(15) NOT NULL, 
  CREATED_AT DATE DEFAULT SYSDATE,
  UPDATE_AT DATE DEFAULT SYSDATE,
  IS_DELETED   NUMBER(1) DEFAULT 0 CHECK (IS_DELETED IN (0,1))
);

CREATE TABLE TAI_KHOAN (
  ACCOUNT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID NUMBER(10) REFERENCES NGUOI_DUNG(USER_ID),
  TEN_TAI_KHOAN NVARCHAR2(255) NOT NULL,
  MAT_KHAU NVARCHAR2(255) NOT NULL,
  TRANG_THAI VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (TRANG_THAI IN('ACTIVE', 'INACTIVE')), -- 'ACTIVE' OR 'INACTIVE'
  CREATED_AT DATE DEFAULT SYSDATE,
  IS_DELETED   NUMBER(1) DEFAULT 0 CHECK (IS_DELETED IN (0,1))
);


CREATE TABLE ACCOUNT_TOKEN (
  TOKEN_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ACCOUNT_ID NUMBER(10) REFERENCES TAI_KHOAN(ACCOUNT_ID),
  TOKEN_VALUE VARCHAR2(500) UNIQUE NOT NULL,
  EXPIRES_AT DATE NOT NULL,
  ISSUED_AT DATE,
  IS_DELETED   NUMBER(1) DEFAULT 0 CHECK (IS_DELETED IN (0,1))
);

CREATE TABLE ACCOUNT_ROLE_GROUP (
  ACCOUNT_ID NUMBER(10) REFERENCES TAI_KHOAN(ACCOUNT_ID),
  ROLE_GROUP_ID NUMBER(10) REFERENCES ROLE_GROUP(GROUP_ID),
  PRIMARY KEY (ACCOUNT_ID, ROLE_GROUP_ID)
);

CREATE TABLE ASSIGN_ROLE_GROUP (
  ROLE_GROUP_ID NUMBER(10) REFERENCES ROLE_GROUP(GROUP_ID),
  ROLE_ID NUMBER(10) REFERENCES ROLE(ROLE_ID),
  PRIMARY KEY (ROLE_GROUP_ID, ROLE_ID)
);

CREATE TABLE ACCOUNT_ASSIGN_ROLE (
  ACCOUNT_ID NUMBER(10) REFERENCES TAI_KHOAN(ACCOUNT_ID),
  ROLE_ID NUMBER(10) REFERENCES ROLE(ROLE_ID),
  PRIMARY KEY (ACCOUNT_ID, ROLE_ID)
);

CREATE TABLE KHACH_HANG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_TAI_KHOAN NUMBER NOT NULL REFERENCES TAI_KHOAN(ACCOUNT_ID) UNIQUE,
  DIA_CHI NVARCHAR2(255),
  DIEM_TICH_LUY INT NOT NULL,
  TINH_TRANG NVARCHAR2(255) NOT NULL
);

CREATE TABLE DOI_TAC (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_TAI_KHOAN NUMBER NOT NULL REFERENCES TAI_KHOAN(ACCOUNT_ID) UNIQUE,
  DIA_CHI NVARCHAR2(255) NOT NULL,
  TAIKHOAN_NGANHANG NVARCHAR2(15) NOT NULL,
  TEN_TKNH NVARCHAR2(255) NOT NULL,
  TEN_NGANHANG NVARCHAR2(255) NOT NULL,
  SO_DU DECIMAL(12,2) DEFAULT 0 CHECK(SO_DU >= 0),
  TINH_TRANG NVARCHAR2(255) NOT NULL
);

CREATE TABLE LICH_SU_RUT_TIEN (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_DOI_TAC NUMBER NOT NULL REFERENCES DOI_TAC(ID),
  SOTIEN DECIMAL(12,2) NOT NULL,
  THOIGIAN_TAO TIMESTAMP NOT NULL,
  THOIGIAN_RUTTIEN TIMESTAMP NOT NULL,
  TRANG_THAI NVARCHAR2(255) NOT NULL 
);

CREATE TABLE THANH_PHO (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TEN_THANH_PHO NVARCHAR2(255) NOT NULL
);

CREATE TABLE QUAN (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_THANH_PHO NUMBER NOT NULL REFERENCES THANH_PHO(ID),
  TEN_QUAN NVARCHAR2(255) NOT NULL
);

CREATE TABLE PHUONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_QUAN NUMBER NOT NULL REFERENCES QUAN(ID),
  TEN_PHUONG NVARCHAR2(255) NOT NULL
);

CREATE TABLE KHU_NGHI_DUONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_DOI_TAC NUMBER NOT NULL REFERENCES DOI_TAC(ID),
  TEN NVARCHAR2(255) NOT NULL,
  DIA_CHI NVARCHAR2(255) NOT NULL,
  PHUONG_ID NUMBER NOT NULL REFERENCES PHUONG(ID),
  MO_TA NVARCHAR2(255) NOT NULL,
  IMG_360_URL NVARCHAR2(255) NOT NULL,
  DANH_GIA INT NOT NULL
);

CREATE TABLE HINH_KHU_NGHI_DUONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_KHU_NGHI_DUONG NUMBER NOT NULL REFERENCES KHU_NGHI_DUONG(ID),
  URL NVARCHAR2(255) NOT NULL
);

CREATE TABLE DANH_GIA (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_KHU_NGHI_DUONG NUMBER NOT NULL REFERENCES KHU_NGHI_DUONG(ID),
  ID_KHACH_HANG NUMBER NOT NULL REFERENCES KHACH_HANG(ID),
  DIEM INT NOT NULL,
  NOI_DUNG NVARCHAR2(1000),
  THOIGIAN_TAO TIMESTAMP NOT NULL
);  

SELECT * FROM DANH_GIA

CREATE TABLE LOAI_PHONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_KHU_NGHI_DUONG NUMBER NOT NULL REFERENCES KHU_NGHI_DUONG(ID),
  TEN_LOAI_PHONG NVARCHAR2(255) NOT NULL,
  DIEN_TICH FLOAT NOT NULL,
  LOAI_PHONG_THEO_SO_LUONG NVARCHAR2(255) NOT NULL,
  LOAI_PHONG_THEO_TIEU_CHUAN NVARCHAR2(255) NOT NULL,
  SO_GIUONG INT NOT NULL,
  SO_NGUOI INT NOT NULL,
  GIA DECIMAL(12,2) NOT NULL
);

CREATE TABLE HINH_PHONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_LOAI_PHONG NUMBER NOT NULL REFERENCES LOAI_PHONG(ID),
  URL NVARCHAR2(255) NOT NULL
);

CREATE TABLE TIEN_ICH (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  LOAI_TIEN_ICH NVARCHAR2(255) NOT NULL,
  ICON_URL NVARCHAR2(255) NOT NULL
);

CREATE TABLE TIEN_ICH_PHONG (
  ID_PHONG NUMBER REFERENCES LOAI_PHONG(ID),
  ID_TIEN_ICH NUMBER REFERENCES TIEN_ICH(ID),
  PRIMARY KEY (ID_PHONG, ID_TIEN_ICH)
);

CREATE TABLE PHONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_KHU_NGHI_DUONG NUMBER NOT NULL REFERENCES KHU_NGHI_DUONG(ID),
  ID_LOAI_PHONG NUMBER NOT NULL REFERENCES LOAI_PHONG(ID),
  TRANG_THAI NVARCHAR2(255) NOT NULL
);

CREATE TABLE DICH_VU (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TEN_DICH_VU NVARCHAR2(255) NOT NULL,
  MO_TA NVARCHAR2(255) NOT NULL
);

CREATE TABLE DICH_VU_KHU_NGHI_DUONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_DICH_VU NUMBER NOT NULL REFERENCES DICH_VU(ID),
  ID_RESORT NUMBER NOT NULL REFERENCES KHU_NGHI_DUONG(ID),
  GIA DECIMAL(12,2) NOT NULL
);

CREATE TABLE GOI_DAT_PHONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_LOAI_PHONG NUMBER NOT NULL REFERENCES LOAI_PHONG(ID),
  TONG_GIATIEN DECIMAL(12,2) NOT NULL
);

CREATE TABLE DICH_VU_MAC_DINH (
  ID_DICH_VU_KHU_NGHI_DUONG NUMBER NOT NULL REFERENCES DICH_VU_KHU_NGHI_DUONG(ID),
  ID_GOI_DAT_PHONG NUMBER NOT NULL REFERENCES GOI_DAT_PHONG(ID),
  GIAMGIA DECIMAL(12,2) NOT NULL,
  PRIMARY KEY (ID_DICH_VU_KHU_NGHI_DUONG, ID_GOI_DAT_PHONG)
);

CREATE TABLE DAT_PHONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_KHACH_HANG NUMBER NOT NULL REFERENCES KHACH_HANG(ID),
  THOI_GIAN_TAO TIMESTAMP NOT NULL,
  TRANG_THAI NVARCHAR2(255) NOT NULL,
  TONG_GIATIEN DECIMAL(12,2) NOT NULL,
  TAIKHOAN_NGANHANG NVARCHAR2(15),
  TEN_TKNH NVARCHAR2(255),
  TEN_NGANHANG NVARCHAR2(255)
);

CREATE TABLE GIAMGIA (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_LOAI_PHONG NUMBER NOT NULL REFERENCES LOAI_PHONG(ID),
  TEN_GIAMGIA NVARCHAR2(255) NOT NULL,
  LOAI_GIAMGIA NVARCHAR2(255) NOT NULL,
  GIA_TRI DECIMAL(12,2) NOT NULL,
  MUC_TOI_DA DECIMAL(12,2),
  NGAY_BAT_DAU TIMESTAMP NOT NULL,
  NGAY_KET_THUC TIMESTAMP NOT NULL,
  TRANG_THAI NVARCHAR2(255) NOT NULL
);

CREATE TABLE CHI_TIET_DAT_PHONG (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_DAT_PHONG NUMBER NOT NULL REFERENCES DAT_PHONG(ID),
  ID_GOI_DAT_PHONG NUMBER NOT NULL REFERENCES GOI_DAT_PHONG(ID),
  ID_GIAMGIA NUMBER NOT NULL REFERENCES GIAMGIA(ID),
  SO_LUONG_PHONG INT NOT NULL,
  SO_LUONG_DICH_VU_YEU_CAU INT NOT NULL,
  TONG_GIATIEN DECIMAL(12,2) NOT NULL,
  NGAY_BAT_DAU TIMESTAMP NOT NULL,
  NGAY_KET_THUC TIMESTAMP NOT NULL,
  TRANG_THAI NVARCHAR2(255) NOT NULL
);

CREATE TABLE THOIGIAN_PHONG_BAN (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_PHONG NUMBER NOT NULL REFERENCES PHONG(ID),
  ID_KHACH_HANG NUMBER NOT NULL REFERENCES KHACH_HANG(ID),
  NGAY_BAT_DAU TIMESTAMP NOT NULL,
  NGAY_KET_THUC TIMESTAMP NOT NULL
);



CREATE TABLE KHOA_PHONG(
    ID_PHONG NUMBER NOT NULL REFERENCES PHONG(ID),
    ID_CHI_TIET_DAT_PHONG NUMBER NOT NULL REFERENCES CHI_TIET_DAT_PHONG(ID),
    PRIMARY KEY (ID_PHONG, ID_CHI_TIET_DAT_PHONG)
);

CREATE TABLE DICH_VU_YEU_CAU (
  ID_DICH_VU_KHU_NGHI_DUONG NUMBER NOT NULL REFERENCES DICH_VU_KHU_NGHI_DUONG(ID),
  ID_CHI_TIET_DAT_PHONG NUMBER NOT NULL REFERENCES CHI_TIET_DAT_PHONG(ID),
  PRIMARY KEY (ID_DICH_VU_KHU_NGHI_DUONG, ID_CHI_TIET_DAT_PHONG)
);

CREATE TABLE KHO_MA_GIAM_GIA (
  ID_KHACH_HANG NUMBER NOT NULL REFERENCES KHACH_HANG(ID),
  ID_GIAMGIA NUMBER NOT NULL REFERENCES GIAMGIA(ID),
  PRIMARY KEY (ID_KHACH_HANG, ID_GIAMGIA)
);

CREATE TABLE HOA_DON (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_KHACH_HANG NUMBER NOT NULL REFERENCES KHACH_HANG(ID),
  ID_DOI_TAC NUMBER NOT NULL REFERENCES DOI_TAC(ID),
  ID_CHI_TIET_DAT_PHONG NUMBER NOT NULL REFERENCES CHI_TIET_DAT_PHONG(ID),
  TONG_GIATIEN DECIMAL(12,2) NOT NULL,
  THOIGIAN_THANHTOAN TIMESTAMP NOT NULL,
  HINH_THUC_THANH_TOAN NVARCHAR2(255) NOT NULL
);

CREATE TABLE DOI_DIEM (
  ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ID_MAGIAM NUMBER NOT NULL REFERENCES GIAMGIA(ID),
  GIA_TRI INT
);

SELECT * FROM KHACH_HANG

SELECT * FROM TAI_KHOAN

UPDATE KHACH_HANG 
SET TINH_TRANG='ACTIVE'
WHERE ID=2;

COMMIT