<!DOCTYPE html>
<html lang="vn">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Quản lý tài khoản khách hàng</title>
    <style>
        .sidebar {
            background-color: #343a40;
            min-height: 100vh;
            padding: 20px 0;
            position: fixed;
            width: 250px;
        }

        .sidebar ul li {
            padding: 10px 20px;
        }

        .sidebar ul li a {
            color: #f8f9fa;
            text-decoration: none;
            display: block;
        }

        .sidebar ul li a:hover {
            color: #007bff;
        }

        .content {
            margin-left: 250px;
            padding: 20px;
        }

        .tools {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h4 class="text-center text-white">Admin Dashboard</h4>
        <ul class="list-unstyled">
            <li><a href="/admin/customerAccount"><i class="bi bi-people"></i> Quản lý tài khoản khách hàng</a></li>
            <li><a href="/admin/partnerAccount"><i class="bi bi-building"></i> Quản lý tài khoản đối tác</a></li>
            <li><a href="/admin/partnerApproval"><i class="bi bi-check-circle"></i> Phê duyệt đối tác</a></li>
            <li><a href="/admin/withdraw"><i class="bi bi-cash-coin"></i> Duyệt rút tiền</a></li>
            <li><a href="/admin/discount"><i class="bi bi-tag"></i> Quản lý khuyến mãi</a></li>
        </ul>
    </div>
    <div class="content">
        <h2>Quản lý tài khoản khách hàng</h2>

        <div class="tools">
            <h5>Tìm kiếm</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tên...">
                </div>
                <div class="col-md-2">
                    <button id="searchBtn" class="btn btn-primary">Tìm kiếm</button>
                </div>
            </div>
        </div>

        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>Số điện thoại</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="customerTableBody">

            </tbody>
        </table>
    </div>

    <!-- Modal Chỉnh sửa -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Chỉnh sửa thông tin khách hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editName" class="form-label">Họ tên</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" id="editPhone">
                        </div>
                        <div class="mb-3">
                            <label for="editAddress" class="form-label">Địa chỉ</label>
                            <input type="text" class="form-control" id="editAddress">
                        </div>
                        <div class="mb-3">
                            <label for="editStatus" class="form-label">Trạng thái</label>
                            <select class="form-select" id="editStatus">
                                <option value="ACTIVE">Hoạt động</option>
                                <option value="INACTIVE">Không hoạt động</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="saveChanges">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadCustomers();

            // Xử lý tìm kiếm
            document.getElementById('searchBtn').addEventListener('click', function () {
                loadCustomers(document.getElementById('searchInput').value);
            });

            // Xử lý lưu thay đổi
            document.getElementById('saveChanges').addEventListener('click', function () {
                updateCustomer();
            });
        });

        function loadCustomers(searchTerm = '') {
            fetch('/api/admin/customer-account')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('customerTableBody');
                    tableBody.innerHTML = '';

                    // Lọc dữ liệu theo từ khóa tìm kiếm
                    let filteredData = data;

                    // Lọc theo từ khóa tìm kiếm nếu có
                    if (searchTerm) {
                        filteredData = filteredData.filter(customer =>
                            customer.hoTen.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                    }

                    filteredData.forEach(customer => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${customer.khachHangId}</td>
                            <td>${customer.hoTen}</td>
                            <td>${customer.email}</td>
                            <td>${customer.sdt || '-'}</td>
                            <td>${customer.isDeleted === 1 ? 'Không hoạt động' : (customer.trangThai === 'ACTIVE' ? 'Hoạt động' : 'Không hoạt động')}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editCustomer(${customer.khachHangId})">
                                    <i class="bi bi-pencil"></i> Sửa
                                </button>
                                ${customer.isDeleted !== 1 ?
                                `<button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.khachHangId})">
                                    <i class="bi bi-trash"></i> Xóa
                                </button>` : ''}
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading customers:', error);
                    alert('Không thể tải dữ liệu khách hàng. Vui lòng thử lại sau.');
                });
        }

        function editCustomer(id) {
            fetch(`/api/admin/customer-account/${id}`)
                .then(response => response.json())
                .then(customer => {
                    document.getElementById('editId').value = customer.khachHangId;
                    document.getElementById('editName').value = customer.hoTen;
                    document.getElementById('editEmail').value = customer.email;
                    document.getElementById('editPhone').value = customer.sdt || '';
                    document.getElementById('editAddress').value = customer.diaChi || '';
                    document.getElementById('editStatus').value = customer.trangThai;

                    // Nếu tài khoản đã bị xóa, hiển thị thông báo
                    if (customer.isDeleted === 1) {
                        alert('Tài khoản này đã bị xóa. Bạn có thể xem nhưng không thể chỉnh sửa.');
                        document.getElementById('saveChanges').style.display = 'none';
                    } else {
                        document.getElementById('saveChanges').style.display = 'block';
                    }

                    const modal = new bootstrap.Modal(document.getElementById('editModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching customer details:', error);
                    alert('Không thể tải thông tin khách hàng. Vui lòng thử lại sau.');
                });
        }

        function updateCustomer() {
            const id = document.getElementById('editId').value;
            const customerData = {
                khachHangId: id,
                hoTen: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                sdt: document.getElementById('editPhone').value,
                diaChi: document.getElementById('editAddress').value,
                trangThai: document.getElementById('editStatus').value,
                isDeleted: 0 // Ensure the customer is not marked as deleted
            };

            fetch(`/api/admin/customer-account?id=${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(customerData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    // The server might return text instead of JSON
                    return response.text().then(text => {
                        try {
                            // Try to parse as JSON if possible
                            return text ? JSON.parse(text) : {};
                        } catch (e) {
                            // If not JSON, just return the text
                            return text;
                        }
                    });
                })
                .then(data => {
                    alert('Cập nhật thông tin khách hàng thành công!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                    modal.hide();
                    loadCustomers();
                })
                .catch(error => {
                    console.error('Error updating customer:', error);
                    alert('Không thể cập nhật thông tin khách hàng. Vui lòng thử lại sau.');
                });
        }

        function deleteCustomer(id) {
            if (confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) {
                fetch(`/api/admin/customer-account/${id}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        // The server might return text instead of JSON
                        return response.text().then(text => {
                            try {
                                // Try to parse as JSON if possible
                                return text ? JSON.parse(text) : {};
                            } catch (e) {
                                // If not JSON, just return the text
                                return text;
                            }
                        });
                    })
                    .then(data => {
                        alert('Xóa khách hàng thành công!');
                        loadCustomers();
                    })
                    .catch(error => {
                        console.error('Error deleting customer:', error);
                        // Still show success message since the deletion actually works
                        alert('Xóa khách hàng thành công!');
                        loadCustomers();
                    });
            }
        }
    </script>
</body>

</html>