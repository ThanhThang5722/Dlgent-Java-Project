<!DOCTYPE html>
<html lang="vn">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Phê duyệt đối tác</title>
    <style>
        .sidebar {
            background-color: #343a40;
            min-height: 100vh;
            padding: 20px 0;
            position: fixed;
            width: 250px;
        }

        .sidebar ul li {
            padding: 10px 20px;
        }

        .sidebar ul li a {
            color: #f8f9fa;
            text-decoration: none;
            display: block;
        }

        .sidebar ul li a:hover {
            color: #007bff;
        }

        .content {
            margin-left: 250px;
            padding: 20px;
        }

        .tools {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h4 class="text-center text-white">Admin Dashboard</h4>
        <ul class="list-unstyled">
            <li><a href="/admin/customerAccount"><i class="bi bi-people"></i> Quản lý tài khoản khách hàng</a></li>
            <li><a href="/admin/partnerAccount"><i class="bi bi-building"></i> Quản lý tài khoản đối tác</a></li>
            <li><a href="/admin/partnerApproval"><i class="bi bi-check-circle"></i> Phê duyệt đối tác</a></li>
            <li><a href="/admin/withdraw"><i class="bi bi-cash-coin"></i> Duyệt rút tiền</a></li>
            <li><a href="/admin/discount"><i class="bi bi-tag"></i> Quản lý khuyến mãi</a></li>
        </ul>
    </div>
    <div class="content">
        <h2>Phê duyệt đối tác</h2>

        <div class="tools">
            <h5>Tìm kiếm</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tên...">
                </div>
                <div class="col-md-2">
                    <button id="searchBtn" class="btn btn-primary">Tìm kiếm</button>
                </div>
            </div>
        </div>

        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>Số điện thoại</th>
                    <th>Địa chỉ</th>
                    <th>Tài khoản ngân hàng</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="partnerTableBody">
                <!-- Partner data will be loaded here -->
            </tbody>
        </table>
    </div>

    <!-- Modal Xem chi tiết -->
    <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewModalLabel">Chi tiết đối tác</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Họ tên:</strong> <span id="viewName"></span></p>
                            <p><strong>Email:</strong> <span id="viewEmail"></span></p>
                            <p><strong>Số điện thoại:</strong> <span id="viewPhone"></span></p>
                            <p><strong>CCCD:</strong> <span id="viewCccd"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Địa chỉ:</strong> <span id="viewAddress"></span></p>
                            <p><strong>Tài khoản ngân hàng:</strong> <span id="viewBankAccount"></span></p>
                            <p><strong>Tên tài khoản:</strong> <span id="viewBankAccountName"></span></p>
                            <p><strong>Ngân hàng:</strong> <span id="viewBankName"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-success" id="approveBtn">Phê duyệt</button>
                    <button type="button" class="btn btn-danger" id="rejectBtn">Từ chối</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadPendingPartners();

            // Xử lý tìm kiếm
            document.getElementById('searchBtn').addEventListener('click', function () {
                loadPendingPartners(document.getElementById('searchInput').value);
            });
        });

        function loadPendingPartners(searchTerm = '') {
            fetch('/api/admin/partner-account/approval')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('partnerTableBody');
                    tableBody.innerHTML = '';

                    // Lọc dữ liệu theo từ khóa tìm kiếm
                    let filteredData = data;

                    // Lọc theo từ khóa tìm kiếm nếu có
                    if (searchTerm) {
                        filteredData = filteredData.filter(partner =>
                            partner.hoTen.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                    }

                    filteredData.forEach(partner => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${partner.doiTacId}</td>
                            <td>${partner.hoTen}</td>
                            <td>${partner.email}</td>
                            <td>${partner.sdt || '-'}</td>
                            <td>${partner.diaChi || '-'}</td>
                            <td>${partner.TKNH || '-'}</td>
                            <td><span class="badge bg-warning">Chờ phê duyệt</span></td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewPartner(${partner.doiTacId})">
                                    <i class="bi bi-eye"></i> Xem
                                </button>
                                <button class="btn btn-sm btn-success" onclick="approvePartner(${partner.doiTacId})">
                                    <i class="bi bi-check-circle"></i> Phê duyệt
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="rejectPartner(${partner.doiTacId})">
                                    <i class="bi bi-x-circle"></i> Từ chối
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    if (filteredData.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center">Không có đối tác nào đang chờ phê duyệt</td>
                            </tr>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading partners:', error);
                    alert('Không thể tải dữ liệu đối tác. Vui lòng thử lại sau.');
                });
        }

        function viewPartner(id) {
            fetch(`/api/admin/partner-account/${id}`)
                .then(response => response.json())
                .then(partner => {
                    document.getElementById('viewName').textContent = partner.hoTen;
                    document.getElementById('viewEmail').textContent = partner.email;
                    document.getElementById('viewPhone').textContent = partner.sdt || '-';
                    document.getElementById('viewCccd').textContent = partner.cccd || '-';
                    document.getElementById('viewAddress').textContent = partner.diaChi || '-';
                    document.getElementById('viewBankAccount').textContent = partner.TKNH || '-';
                    document.getElementById('viewBankAccountName').textContent = partner.tenTKNH || '-';
                    document.getElementById('viewBankName').textContent = partner.tenNH || '-';

                    // Set up approve and reject buttons
                    document.getElementById('approveBtn').onclick = function () {
                        approvePartner(id);
                        const modal = bootstrap.Modal.getInstance(document.getElementById('viewModal'));
                        modal.hide();
                    };

                    document.getElementById('rejectBtn').onclick = function () {
                        rejectPartner(id);
                        const modal = bootstrap.Modal.getInstance(document.getElementById('viewModal'));
                        modal.hide();
                    };

                    const modal = new bootstrap.Modal(document.getElementById('viewModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching partner details:', error);
                    alert('Không thể tải thông tin đối tác. Vui lòng thử lại sau.');
                });
        }

        function approvePartner(id) {
            if (confirm('Bạn có chắc chắn muốn phê duyệt đối tác này?')) {
                fetch(`/api/admin/partner-account/approve/${id}`, {
                    method: 'PUT'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(data => {
                        alert('Phê duyệt đối tác thành công!');
                        loadPendingPartners();
                    })
                    .catch(error => {
                        console.error('Error approving partner:', error);
                        alert('Không thể phê duyệt đối tác. Vui lòng thử lại sau.');
                    });
            }
        }

        function rejectPartner(id) {
            if (confirm('Bạn có chắc chắn muốn từ chối đối tác này?')) {
                fetch(`/api/admin/partner-account/reject/${id}`, {
                    method: 'PUT'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(data => {
                        alert('Từ chối đối tác thành công!');
                        loadPendingPartners();
                    })
                    .catch(error => {
                        console.error('Error rejecting partner:', error);
                        alert('Không thể từ chối đối tác. Vui lòng thử lại sau.');
                    });
            }
        }
    </script>
</body>

</html>